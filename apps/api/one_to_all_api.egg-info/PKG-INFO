Metadata-Version: 2.4
Name: one_to_all_api
Version: 0.1.0
Summary: FastAPI backend for One-to-All-app.
Requires-Python: <3.13,>=3.12
Description-Content-Type: text/markdown
Requires-Dist: fastapi>=0.115.0
Requires-Dist: uvicorn[standard]>=0.30.0
Requires-Dist: celery>=5.4.0
Requires-Dist: redis>=5.0.0
Requires-Dist: python-multipart>=0.0.9
Requires-Dist: pip>=24.0
Requires-Dist: py_core
Provides-Extra: dev
Requires-Dist: httpx>=0.27.0; extra == "dev"
Requires-Dist: pytest>=8.0.0; extra == "dev"
Provides-Extra: model-download
Requires-Dist: modelscope>=1.18.0; extra == "model-download"

# one_to_all_api

## Dev run

1. Start dependencies (Redis + Postgres)
   - `docker compose -f infra/docker-compose.dev.yml up -d redis postgres`

2. Install deps
   - `uv sync --project apps/api`

3. Run API
   - `uv run --project apps/api uvicorn main:app --reload --host 0.0.0.0 --port 8000`

## Use pip (inside project venv)

- `uv run --project apps/api pip list`
- `uv run --project apps/api python -m pip list`

## Create a job

- `POST /jobs/one-to-all` with JSON body:
  - `reference_image`: local path or S3 key/URL
  - `motion_video`: local path or S3 key/URL
  - `output_s3_key` (optional): if set and S3 configured, worker uploads result there
- Or upload files: `POST /jobs/one-to-all/upload` (multipart)
  - After success: `GET /jobs/{task_id}/download` (returns mp4 if the API host can access `DATA_DIR`)

## Env

Copy `env.example` to `.env` (do not commit `.env`).

## Download checkpoints (ModelScope)

- Install optional deps: `uv sync --project apps/api --extra model_download`
- Download (skips if already present): `uv run --project apps/api scripts/download_modelscope_one_to_all.py --model 14b`

## Quantize checkpoints to FP8 (optional)

- Install deps in worker env: `uv sync --project apps/worker --extra fp8_quant`
- Quantize to `models/<name>-FP8/`: `uv run --project apps/worker scripts/quantize_one_to_all_fp8.py --model 14b --dtype e5m2`

## One-to-All-Animation pretrained models (required for inference)

Upstream inference also needs the base Wan2.1 Diffusers weights + pose preprocess checkpoints.

- Download into `models/One-to-All-14b/pretrained_models/`:
  - `uv sync --project apps/api --extra model_download`
  - Download (or refresh missing files):
    - `uv run --project apps/api scripts/download_one_to_all_animation_pretrained.py --with-wan-14b`
    - If you really need the base Wan `transformer/` weights too: add `--with-wan-transformer` (usually unnecessary)
  - If you already have them under `models/One-to-All-Animation/pretrained_models/`, migrate:
    - `uv run --project apps/api scripts/prepare_one_to_all_14b_model_repo.py`
